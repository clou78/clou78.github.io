<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebOS V3.0.0 - Ultimate Hybrid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --grid-size: 75px;
            --theme-bg: rgba(15, 15, 15, 0.8);
            --theme-text: #ffffff;
            --theme-window-bg: rgba(255, 255, 255, 0.9);
            --theme-accent: #0078d4;
        }

        .theme-light {
            --theme-bg: rgba(250, 250, 250, 0.85);
            --theme-text: #000000;
            --theme-window-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
            user-select: none;
            background-color: #000;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            font-size: 14px;
        }

        .glass {
            background: var(--theme-window-bg);
            backdrop-filter: blur(30px) saturate(160%);
            -webkit-backdrop-filter: blur(30px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: var(--theme-bg);
            backdrop-filter: blur(30px) saturate(160%);
            -webkit-backdrop-filter: blur(30px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--theme-text);
        }

        .window {
            position: absolute;
            min-width: 280px;
            min-height: 200px;
            max-width: 98vw;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            animation: window-open 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 100;
            pointer-events: auto;
        }

        .resizer {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            z-index: 101;
        }

        @media (max-width: 768px) {
            :root { --grid-size: 65px; }
            .window {
                width: 94vw !important;
                height: 75vh !important;
                left: 3vw !important;
                top: 40px !important;
            }
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.8s ease-out forwards; }

        @keyframes window-open {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .desktop-icon {
            width: 85px;
            height: 95px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
            transition: background 0.15s, transform 0.1s;
            pointer-events: auto;
            position: absolute;
            z-index: 10;
            will-change: left, top, transform;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .desktop-icon.dragging {
            opacity: 0.7;
            z-index: 1000;
            transition: none;
            transform: scale(1.05);
        }

        .taskbar-item {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .taskbar-item:hover {
            transform: translateY(-8px) scale(1.1);
        }

        #desktop {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            width: 100vw;
            height: 100vh;
            transition: background-image 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #0f172a;
        }

        .start-menu {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(calc(100% + 200px));
            width: min(540px, 95vw);
            height: min(640px, 75vh);
            border-radius: 24px;
            transition: all 0.5s cubic-bezier(0.1, 0.9, 0.2, 1);
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 0 100px rgba(0,0,0,0.5);
        }

        .start-menu.open {
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
            opacity: 1;
        }

        #system-toast {
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            top: -100px; /* Hidden state */
        }

        #system-toast.show {
            top: 15px;
        }

        canvas#paint-canvas {
            cursor: crosshair;
            background: white;
            touch-action: none;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="dark-theme">

    <div id="orientation-overlay" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white p-6 text-center">
        <div class="bg-white/10 p-8 rounded-3xl backdrop-blur-xl border border-white/20 shadow-2xl max-w-md">
            <i data-lucide="monitor-smartphone" class="w-16 h-16 mb-6 mx-auto text-blue-400"></i>
            <h1 class="text-3xl font-bold mb-4">WebOS V3.0.0</h1>
            <p class="text-gray-300 mb-8 text-sm">Новое поколение WebOS. Оптимизировано для высокой производительности. Пожалуйста, используйте альбомную ориентацию.</p>
            <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-lg">
                Вступить в Систему
            </button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[9998] hidden flex flex-col items-center justify-center text-white">
        <div id="login-bg" class="absolute inset-0 bg-cover bg-center scale-105 blur-3xl saturate-150 transition-all duration-1000 brightness-50"></div>
        <!-- Lock Screen Wallpaper (Generated design fallback) -->
        <div id="login-fallback-bg" class="absolute inset-0 -z-1 overflow-hidden opacity-50">
            <div class="absolute w-[500px] h-[500px] bg-indigo-500 rounded-full -top-40 -left-40 blur-[120px] animate-pulse"></div>
            <div class="absolute w-[400px] h-[400px] bg-purple-600 rounded-full -bottom-40 -right-40 blur-[120px] animate-bounce" style="animation-duration: 10s"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center animate-fade-in">
            <div class="w-20 h-20 bg-white/10 rounded-full backdrop-blur-2xl border border-white/20 flex items-center justify-center mb-6 shadow-2xl overflow-hidden">
                <div class="w-full h-full bg-gradient-to-tr from-indigo-500 to-pink-500 opacity-80 flex items-center justify-center">
                    <i data-lucide="user" class="w-10 h-10 text-white"></i>
                </div>
            </div>
            <div id="login-time" class="text-6xl font-light mb-2 tracking-tighter">00:00</div>
            <div id="login-date" class="text-lg opacity-80 mb-12">Понедельник, 1 Января</div>
            <div class="relative group">
                <input type="password" id="login-pass" placeholder="Пароль (admin)" class="bg-black/20 border border-white/10 rounded-2xl px-6 py-3 w-64 backdrop-blur-3xl outline-none focus:bg-black/40 focus:border-white/30 transition-all text-center placeholder:text-white/30">
                <button id="login-submit" class="absolute right-2 top-2 w-8 h-8 bg-white/10 rounded-xl flex items-center justify-center hover:bg-white/20 transition-all">
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- System Notification Toast -->
    <div id="system-toast" class="fixed left-1/2 -translate-x-1/2 glass-dark px-6 py-3 rounded-full z-[10001] flex items-center space-x-3 pointer-events-none shadow-2xl">
        <div id="toast-icon" class="text-blue-400"></div>
        <span id="toast-message" class="text-sm font-medium"></span>
    </div>

    <div id="desktop" class="hidden">
        
        <!-- Top Menu Bar -->
        <div class="fixed top-0 left-0 w-full h-8 glass-dark flex items-center justify-between px-4 z-[1000] text-[13px] font-medium shadow-sm">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-1 cursor-pointer hover:opacity-70 transition-opacity" onclick="toggleStartMenu()">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    <span class="font-bold tracking-tight">System</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="opacity-80 cursor-pointer hover:opacity-100 transition-opacity" onclick="toggleTheme()">Тема</span>
                    <span class="opacity-80 cursor-pointer hover:opacity-100 transition-opacity" onclick="changeWallpaper()">Обои</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <i data-lucide="wifi" class="w-4 h-4 text-blue-400"></i>
                <i data-lucide="battery" class="w-4 h-4"></i>
                <span id="clock" class="font-semibold">00:00:00</span>
            </div>
        </div>

        <!-- Desktop Grid System -->
        <div id="desktop-icons-container" class="absolute inset-0 pt-10 pb-20 px-4">
            <!-- Icons will be generated by JS -->
        </div>

        <div id="window-layer" class="absolute inset-0 pointer-events-none"></div>

        <!-- Start Menu (Win11 style) -->
        <div id="start-menu" class="start-menu glass-dark p-6 flex flex-col shadow-2xl">
            <div class="flex-grow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-bold text-[11px] opacity-60 uppercase tracking-widest">Приложения</h2>
                    <button onclick="document.getElementById('wallpaper-input').click()" class="text-[10px] bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition-all flex items-center">
                        <i data-lucide="upload" class="w-3 h-3 mr-1"></i> Свои обои
                    </button>
                    <input type="file" id="wallpaper-input" class="hidden" accept="image/*" onchange="uploadWallpaper(event)">
                </div>
                <div class="grid grid-cols-4 gap-6">
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('browser')">
                        <div class="w-11 h-11 bg-blue-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="globe" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Safari</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('explorer')">
                        <div class="w-11 h-11 bg-yellow-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="folder" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Finder</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('paint')">
                        <div class="w-11 h-11 bg-rose-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="palette" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Sketch</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('calc')">
                        <div class="w-11 h-11 bg-orange-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="calculator" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Calc</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('terminal')">
                        <div class="w-11 h-11 bg-zinc-800 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="terminal" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Terminal</span>
                    </div>
                    <div class="flex flex-col items-center space-y-2 cursor-pointer group" onclick="openWindow('notepad')">
                        <div class="w-11 h-11 bg-sky-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="file-text" class="text-white w-5 h-5"></i></div>
                        <span class="text-[10px] font-medium">Notes</span>
                    </div>
                </div>
            </div>
            <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg"><i data-lucide="user" class="w-4 h-4 text-white"></i></div>
                    <div class="flex flex-col">
                        <span class="text-[11px] font-bold">Admin User</span>
                        <span class="text-[9px] opacity-40">Online</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <i data-lucide="settings" class="w-4 h-4 cursor-pointer opacity-40 hover:opacity-100 transition-opacity"></i>
                    <i data-lucide="power" class="w-4 h-4 text-rose-500 cursor-pointer hover:scale-110 transition-transform" onclick="location.reload()"></i>
                </div>
            </div>
        </div>

        <!-- Taskbar (Win11/MacOS Hybrid) -->
        <div class="fixed bottom-4 left-1/2 -translate-x-1/2 h-[64px] glass-dark rounded-2xl flex items-center px-4 space-x-3 z-[9999] shadow-2xl">
            <div class="taskbar-item cursor-pointer p-2 rounded-lg hover:bg-white/10" onclick="toggleStartMenu()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Windows_logo_-_2021.svg" class="w-7 h-7" alt="Start">
            </div>
            <div class="w-[1px] h-8 bg-white/10 mx-1"></div>
            <div class="taskbar-item cursor-pointer" onclick="openWindow('explorer')">
                <div class="w-11 h-11 bg-yellow-500/80 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="folder" class="text-white w-6 h-6"></i></div>
            </div>
            <div class="taskbar-item cursor-pointer" onclick="openWindow('browser')">
                <div class="w-11 h-11 bg-blue-500/80 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="globe" class="text-white w-6 h-6"></i></div>
            </div>
            <div class="taskbar-item cursor-pointer" onclick="openWindow('terminal')">
                <div class="w-11 h-11 bg-slate-800 rounded-xl flex items-center justify-center shadow-lg border border-white/20"><i data-lucide="terminal" class="text-white w-6 h-6"></i></div>
            </div>
            <div class="taskbar-item cursor-pointer" onclick="openWindow('mail')">
                <div class="w-11 h-11 bg-red-500/80 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="mail" class="text-white w-6 h-6"></i></div>
            </div>
            <div class="taskbar-item cursor-pointer" onclick="changeWallpaper()">
                <div class="w-11 h-11 bg-emerald-500/80 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="image" class="text-white w-6 h-6"></i></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const state = {
            activeWindows: new Set(),
            zIndex: 100,
            isDarkMode: true,
            clipboard: null, // { type, name, info }
            wallpapers: [
                'https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1614850523296-d8c1af93d400?auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1541701494587-cb58502866ab?auto=format&fit=crop&w=1920&q=80'
            ],
            currentWallpaper: 0,
            customWallpaper: localStorage.getItem('webos_custom_wallpaper') || null,
            icons: [
                { id: 'explorer', name: 'Finder', icon: 'folder', color: 'text-yellow-400', x: 20, y: 50 },
                { id: 'browser', name: 'Safari', icon: 'globe', color: 'text-blue-500', x: 20, y: 135 },
                { id: 'terminal', name: 'Terminal', icon: 'terminal', color: 'text-zinc-200', x: 20, y: 220 },
                { id: 'notepad', name: 'Notes', icon: 'file-text', color: 'text-sky-300', x: 20, y: 305 },
                { id: 'paint', name: 'Sketch', icon: 'palette', color: 'text-rose-400', x: 20, y: 390 },
                { id: 'mail', name: 'Mail', icon: 'mail', color: 'text-red-400', x: 100, y: 50 },
                { id: 'calc', name: 'Calc', icon: 'calculator', color: 'text-orange-400', x: 100, y: 135 }
            ],
            fs: {
                currentPath: 'C:',
                root: {
                    'C:': {
                        type: 'dir',
                        children: {
                            'Documents': { type: 'dir', children: { 'Draft.txt': { type: 'file', content: 'New WebOS project started.' } } },
                            'System': { type: 'dir', children: { 'boot.sys': { type: 'file', content: 'SYS_BOOT_V3' } } },
                            'ReadMe.txt': { type: 'file', content: 'Welcome to WebOS V3.0.0!' }
                        }
                    }
                }
            }
        };

        const getGridSize = () => window.innerWidth < 900 ? 70 : 85;
        const getGridOffsetX = () => 20;
        const getGridOffsetY = () => 60;

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            const body = document.body;
            if (state.isDarkMode) {
                body.classList.remove('theme-light');
                showToast('Темная тема включена', 'moon');
            } else {
                body.classList.add('theme-light');
                showToast('Светлая тема включена', 'sun');
            }
        }

        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('orientation-overlay');
        const desktop = document.getElementById('desktop');
        const clockEl = document.getElementById('clock');
        const windowLayer = document.getElementById('window-layer');
        const iconsContainer = document.getElementById('desktop-icons-container');
        const startMenu = document.getElementById('start-menu');

        startBtn.addEventListener('click', () => {
            function enterFS() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
            }
            enterFS();
            overlay.classList.add('hidden');
            const loginScreen = document.getElementById('login-screen');
            const loginBg = document.getElementById('login-bg');
            loginScreen.classList.remove('hidden');
            loginBg.style.backgroundImage = `url('${state.wallpapers[state.currentWallpaper]}')`;
            document.body.addEventListener('click', enterFS, { once: true });
            const savedWP = localStorage.getItem('webos_wallpaper');
            if (savedWP !== null) state.currentWallpaper = parseInt(savedWP) % state.wallpapers.length;
        });

        const loginSubmit = document.getElementById('login-submit');
        const loginPass = document.getElementById('login-pass');

        function doLogin() {
            document.getElementById('login-screen').classList.add('hidden');
            desktop.classList.remove('hidden');
            applyWallpaper();
            renderIcons();
            showToast('Добро пожаловать, WebUser', 'user');
        }

        loginSubmit.addEventListener('click', doLogin);
        loginPass.addEventListener('keypress', (e) => { if(e.key === 'Enter') doLogin(); });

        desktop.addEventListener('click', (e) => {
            if (e.target.id === 'desktop-icons-container' || e.target.id === 'desktop' || e.target.id === 'window-layer') {
                startMenu.classList.remove('open');
            }
        });

        function applyWallpaper() {
            const url = state.customWallpaper || state.wallpapers[state.currentWallpaper];
            document.getElementById('desktop').style.backgroundImage = `url('${url}')`;
            document.getElementById('login-bg').style.backgroundImage = `url('${url}')`;
        }

        function uploadWallpaper(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                state.customWallpaper = ev.target.result;
                localStorage.setItem('webos_custom_wallpaper', state.customWallpaper);
                applyWallpaper();
                showToast('Обои обновлены', 'image');
            };
            reader.readAsDataURL(file);
        }

        function updateClock() {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const loginTime = document.getElementById('login-time');
            const loginDate = document.getElementById('login-date');
            if(loginTime) loginTime.textContent = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            if(loginDate) loginDate.textContent = now.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        function toggleStartMenu() {
            startMenu.classList.toggle('open');
        }

        function changeWallpaper() {
            state.currentWallpaper = (state.currentWallpaper + 1) % state.wallpapers.length;
            const desktopEl = document.getElementById('desktop');
            const newUrl = state.wallpapers[state.currentWallpaper];
            desktopEl.style.backgroundImage = `url('${newUrl}')`;
            localStorage.setItem('webos_wallpaper', state.currentWallpaper);
            showToast('Обои изменены', 'image');
        }

        function renderIcons() {
            iconsContainer.innerHTML = '';
            const occupiedSlots = new Set();
            const GRID = getGridSize();

            state.icons.forEach(iconData => {
                const icon = document.createElement('div');
                icon.className = 'desktop-icon group select-none';
                icon.style.left = iconData.x + 'px';
                icon.style.top = iconData.y + 'px';
                icon.innerHTML = `
                    <div class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center border border-white/10 group-hover:bg-white/20 transition-all pointer-events-none">
                        <i data-lucide="${iconData.icon}" class="${iconData.color} w-6 h-6"></i>
                    </div>
                    <span class="text-white text-[10px] mt-1.5 font-semibold drop-shadow-lg text-center px-1 pointer-events-none">${iconData.name}</span>
                `;
                
                icon.addEventListener('mousedown', (e) => startIconDrag(e, icon, iconData));
                icon.addEventListener('touchstart', (e) => startIconDrag(e, icon, iconData), {passive: false});
                
                iconsContainer.appendChild(icon);
            });
            lucide.createIcons();
        }

        function startIconDrag(e, el, data) {
            const isTouch = e.type.startsWith('touch');
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            if (!isTouch && e.button !== 0) return;

            let startX = clientX - data.x;
            let startY = clientY - data.y;
            let moveCount = 0;
            const threshold = 10;

            function onMove(e) {
                const curX = isTouch ? e.touches[0].clientX : e.clientX;
                const curY = isTouch ? e.touches[0].clientY : e.clientY;
                
                const dx = Math.abs(curX - (data.x + startX));
                const dy = Math.abs(curY - (data.y + startY));
                moveCount += dx + dy;

                if (moveCount > 15) {
                    el.classList.add('dragging');
                    data.x = curX - startX;
                    data.y = curY - startY;
                    el.style.left = data.x + 'px';
                    el.style.top = data.y + 'px';
                }
            }

            function onEnd() {
                document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
                
                const GRID = getGridSize();
                if (moveCount <= 15) {
                    openWindow(data.id);
                } else {
                    el.classList.remove('dragging');
                    const maxX = window.innerWidth - GRID;
                    const maxY = window.innerHeight - (GRID * 2.5);
                    
                    data.x = Math.max(getGridOffsetX(), Math.min(maxX, Math.round((data.x - getGridOffsetX()) / GRID) * GRID + getGridOffsetX()));
                    data.y = Math.max(getGridOffsetY(), Math.min(maxY, Math.round((data.y - getGridOffsetY()) / GRID) * GRID + getGridOffsetY()));
                    
                    // Simple collision avoidance on drop
                    state.icons.forEach(other => {
                        if (other !== data && Math.abs(other.x - data.x) < 10 && Math.abs(other.y - data.y) < 10) {
                            data.x += GRID;
                            if (data.x > maxX) data.x = getGridOffsetX();
                        }
                    });

                    el.style.left = data.x + 'px';
                    el.style.top = data.y + 'px';
                }
            }

            document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
            document.addEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
        }

        function showToast(msg, iconName = 'info') {
            const toast = document.getElementById('system-toast');
            const icon = document.getElementById('toast-icon');
            const message = document.getElementById('toast-message');
            
            icon.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
            message.textContent = msg;
            lucide.createIcons();
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- Window Manager ---
        function openWindow(type, data = null) {
            startMenu.classList.remove('open');
            if (state.activeWindows.has(type)) {
                focusWindow(type);
                if (type === 'notepad' && data) {
                    const ta = document.querySelector(`#window-notepad textarea`);
                    if (ta) ta.value = data;
                }
                return;
            }

            const win = document.createElement('div');
            win.id = `window-${type}`;
            win.className = 'window glass pointer-events-auto';
            
            const isMobile = window.innerWidth < 640;
            const offset = Math.min(state.activeWindows.size * 20, 100);
            win.style.top = isMobile ? '45px' : (80 + offset) + 'px';
            win.style.left = isMobile ? '2vw' : (120 + offset) + 'px';
            win.style.width = isMobile ? '96vw' : '700px';
            win.style.height = isMobile ? '80vh' : '500px';
            win.style.zIndex = ++state.zIndex;

            let content = '';
            let title = type.charAt(0).toUpperCase() + type.slice(1);

            const trafficLights = `
                <div class="flex items-center space-x-2 mr-4">
                    <div class="w-3 h-3 rounded-full bg-rose-500 hover:bg-rose-600 cursor-pointer shadow-sm transition-colors" onclick="closeWindow('${type}')"></div>
                    <div class="w-3 h-3 rounded-full bg-amber-500 cursor-pointer shadow-sm"></div>
                    <div class="w-3 h-3 rounded-full bg-emerald-500 cursor-pointer shadow-sm"></div>
                </div>
            `;

            switch(type) {
                case 'explorer':
                    title = 'Finder';
                    content = `
                        <div class="flex-grow flex flex-col bg-white text-gray-800 h-full">
                            <div class="flex items-center space-x-2 p-2 bg-gray-50 border-b border-gray-100">
                                <button onclick="navigateBack()" class="p-1.5 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                <div id="explorer-path" class="text-[10px] font-bold text-gray-400 bg-white border border-gray-200 px-3 py-1 flex-grow rounded-lg overflow-hidden truncate">C:/</div>
                                <div class="flex items-center space-x-1">
                                    <button onclick="fsNew('dir')" class="p-1.5 hover:bg-gray-200 rounded-lg text-blue-600" title="Новая папка"><i data-lucide="folder-plus" class="w-4 h-4"></i></button>
                                    <button onclick="fsNew('file')" class="p-1.5 hover:bg-gray-200 rounded-lg text-blue-600" title="Новый файл"><i data-lucide="file-plus" class="w-4 h-4"></i></button>
                                    <button id="explorer-paste" onclick="fsPaste()" class="p-1.5 hover:bg-gray-200 rounded-lg text-emerald-600 hidden" title="Вставить"><i data-lucide="clipboard" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div id="explorer-content" class="flex-grow p-4 grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 content-start overflow-y-auto">
                            </div>
                        </div>`;
                    break;
                case 'browser':
                    title = 'Safari';
                    content = `
                        <div class="bg-gray-100 flex items-center px-4 py-1.5 border-b border-gray-200 space-x-3">
                            <div class="flex space-x-3 text-gray-400"><i data-lucide="arrow-left" class="w-3.5 h-3.5"></i><i data-lucide="arrow-right" class="w-3.5 h-3.5"></i></div>
                            <input type="text" id="browser-url" value="https://www.wikipedia.org" class="flex-grow bg-white border border-gray-300 rounded-lg px-4 py-1 text-[11px] outline-none focus:ring-1 focus:ring-blue-400 transition-all shadow-sm">
                            <button onclick="loadUrl()" class="text-[10px] bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md font-bold transition-all">Go</button>
                        </div>
                        <div class="flex-grow bg-white relative">
                            <iframe id="browser-frame" src="https://www.wikipedia.org" class="w-full h-full border-none"></iframe>
                        </div>`;
                    break;
                case 'calc':
                    title = 'Calc';
                    content = `
                        <div class="flex-grow bg-[#f0f0f0] p-4 flex flex-col">
                            <div id="calc-display" class="bg-white p-4 text-right text-3xl font-light mb-4 border border-gray-200 rounded-xl h-20 flex items-end justify-end overflow-hidden shadow-inner">0</div>
                            <div class="grid grid-cols-4 gap-2 flex-grow">
                                ${['C','/','*','-','7','8','9','+','4','5','6','=','1','2','3','0'].map(b => `
                                    <button onclick="handleCalc('${b}')" class="${b === '=' ? 'bg-orange-500 text-white' : 'bg-white hover:bg-gray-100'} border border-gray-200 rounded-xl text-lg font-medium transition-all shadow-sm active:scale-90">${b}</button>
                                `).join('')}
                            </div>
                        </div>`;
                    break;
                case 'notepad':
                    title = 'Notes';
                    const savedText = data || localStorage.getItem('webos_notepad') || '';
                    content = `
                        <div class="bg-gray-50 flex items-center px-4 py-1 border-b border-gray-200 text-[10px] font-bold space-x-4">
                            <span class="cursor-pointer hover:text-blue-600 transition-colors uppercase tracking-wider" onclick="saveNotepad()">Save</span>
                            <span class="cursor-pointer hover:text-rose-600 transition-colors uppercase tracking-wider" onclick="document.getElementById('notepad-text').value = ''">Clear</span>
                        </div>
                        <textarea id="notepad-text" class="flex-grow p-6 outline-none resize-none font-mono text-sm leading-relaxed bg-white text-zinc-700" placeholder="Type something...">${savedText}</textarea>
                    `;
                    break;
                case 'terminal':
                    title = 'Terminal';
                    content = `
                        <div class="flex-grow bg-[#111111] text-[#00ff41] p-5 font-mono text-[12px] overflow-y-auto" id="term-body">
                            <div class="mb-2 opacity-50">WebOS Terminal V3.0.0 [Kernel v3.1.2]<br>System initialized...</div>
                            <div id="term-output"></div>
                            <div class="flex items-center mt-1">
                                <span class="mr-2 text-white">admin@webos:~$</span>
                                <input type="text" id="term-input" class="bg-transparent border-none outline-none flex-grow text-[#00ff41]" autofocus spellcheck="false">
                            </div>
                        </div>`;
                    break;
                case 'paint':
                    title = 'Sketch';
                    content = `
                        <div class="bg-gray-50 border-b border-gray-200 p-2 flex flex-wrap items-center gap-3">
                            <input type="color" id="paint-color" class="w-6 h-6 cursor-pointer border-none bg-transparent">
                            <input type="range" id="paint-size" min="1" max="50" value="5" class="w-16 accent-blue-600">
                            <button onclick="clearPaint()" class="text-[9px] font-bold bg-white border border-gray-200 px-3 py-1 rounded hover:bg-gray-100 uppercase tracking-widest"><i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i> Clear</button>
                            <button onclick="savePaint()" class="text-[9px] font-bold bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 uppercase tracking-widest"><i data-lucide="download" class="w-3 h-3 inline mr-1"></i> Export</button>
                        </div>
                        <div class="flex-grow bg-zinc-100 overflow-auto flex items-center justify-center p-4">
                            <canvas id="paint-canvas" width="700" height="400" class="shadow-lg bg-white rounded"></canvas>
                        </div>`;
                    break;
            }

            win.innerHTML = `
                <div class="window-header h-9 glass-dark border-b border-white/10 flex items-center px-4 cursor-move shrink-0">
                    ${trafficLights}
                    <div class="flex-grow text-center text-[11px] font-bold tracking-tight text-white/50">${title}</div>
                    <div class="w-20"></div>
                </div>
                <div class="flex-grow flex flex-col overflow-hidden bg-white">
                    ${content}
                </div>
                <div class="resizer"></div>
            `;

            windowLayer.appendChild(win);
            state.activeWindows.add(type);
            makeDraggable(win);
            makeResizable(win);
            win.addEventListener('mousedown', () => focusWindow(type));
            win.addEventListener('touchstart', () => focusWindow(type), {passive: true});
            
            if (type === 'terminal') initTerminal();
            if (type === 'paint') initPaint();
            if (type === 'explorer') updateExplorer();
            lucide.createIcons();
        }

        function makeResizable(win) {
            const resizer = win.querySelector('.resizer');
            if(!resizer) return;

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const startWidth = win.offsetWidth;
                const startHeight = win.offsetHeight;
                const startX = e.clientX;
                const startY = e.clientY;

                const onMove = (me) => {
                    win.style.width = startWidth + (me.clientX - startX) + 'px';
                    win.style.height = startHeight + (me.clientY - startY) + 'px';
                };

                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
            });
            
            resizer.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const startWidth = win.offsetWidth;
                const startHeight = win.offsetHeight;
                const startX = touch.clientX;
                const startY = touch.clientY;

                const onMove = (te) => {
                    const t = te.touches[0];
                    win.style.width = startWidth + (t.clientX - startX) + 'px';
                    win.style.height = startHeight + (t.clientY - startY) + 'px';
                };

                const onEnd = () => {
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };

                document.addEventListener('touchmove', onMove, {passive: false});
                document.addEventListener('touchend', onEnd);
            }, {passive: false});
        }

        function makeDraggable(el) {
            const h = el.querySelector('.window-header');
            
            const startMove = (e) => {
                const isTouch = e.type === 'touchstart';
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                
                if (!isTouch && e.button !== 0) return;
                if (e.target.closest('.traffic-light') || e.target.classList.contains('w-3')) return;
                
                const shiftX = clientX - el.getBoundingClientRect().left;
                const shiftY = clientY - el.getBoundingClientRect().top;
                
                const onMove = (e) => {
                    const curX = (isTouch ? e.touches[0].clientX : e.clientX) - shiftX;
                    const curY = (isTouch ? e.touches[0].clientY : e.clientY) - shiftY;
                    el.style.left = curX + "px";
                    el.style.top = curY + "px";
                };

                const onEnd = () => {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
                };

                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
            };

            h.addEventListener('mousedown', startMove);
            h.addEventListener('touchstart', startMove, {passive: false});
        }

        function closeWindow(type) {
            const win = document.getElementById(`window-${type}`);
            if (win) {
                win.style.opacity = '0';
                win.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    win.remove();
                    state.activeWindows.delete(type);
                }, 200);
            }
        }

        function focusWindow(type) {
            const win = document.getElementById(`window-${type}`);
            if (win) win.style.zIndex = ++state.zIndex;
        }

        function makeDraggable(el) {
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            const h = el.querySelector('.window-header');
            
            const startMove = (e) => {
                const isTouch = e.type === 'touchstart';
                if (!isTouch && e.button !== 0) return;
                if (e.target.classList.contains('w-3')) return;
                
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                
                p3 = clientX; p4 = clientY;
                
                const onMove = (e) => {
                    const curX = isTouch ? e.touches[0].clientX : e.clientX;
                    const curY = isTouch ? e.touches[0].clientY : e.clientY;
                    p1 = p3 - curX; p2 = p4 - curY;
                    p3 = curX; p4 = curY;
                    el.style.top = (el.offsetTop - p2) + "px";
                    el.style.left = (el.offsetLeft - p1) + "px";
                };

                const onEnd = () => {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
                };

                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
            };

            h.addEventListener('mousedown', startMove);
            h.addEventListener('touchstart', startMove, {passive: false});
        }

        // --- Calc Logic ---
        let calcVal = '';
        function handleCalc(val) {
            const disp = document.getElementById('calc-display');
            if (val === 'C') calcVal = '';
            else if (val === '=') {
                try { 
                    // Sanitize input to only allow math
                    const sanitized = calcVal.replace(/[^-+*/.0-9]/g, '');
                    calcVal = eval(sanitized).toString(); 
                } catch { calcVal = 'Error'; }
            } else {
                if (calcVal === 'Error') calcVal = '';
                calcVal += val;
            }
            disp.textContent = calcVal || '0';
        }

        // --- Terminal Logic ---
        function initTerminal() {
            const input = document.getElementById('term-input');
            const output = document.getElementById('term-output');
            const body = document.getElementById('term-body');
            if(!input) return;

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const val = input.value.trim();
                    const parts = val.split(' ');
                    const cmd = parts[0].toLowerCase();
                    output.innerHTML += `<div class="flex items-center space-x-2 mt-2"><span class="text-emerald-500 font-bold">admin@webos:~$</span> <span class="text-zinc-300">${val}</span></div>`;
                    
                    let res = '';
                    switch(cmd) {
                        case 'help': res = 'Commands: help, ls, neofetch, clear, date, echo, theme, exit, system'; break;
                        case 'ls': 
                            const dir = getPointerDir();
                            res = Object.keys(dir).join('  ');
                            break;
                        case 'clear': output.innerHTML = ''; res = ''; break;
                        case 'date': res = new Date().toLocaleString(); break;
                        case 'echo': res = parts.slice(1).join(' '); break;
                        case 'theme': toggleTheme(); res = 'UI Theme toggled.'; break;
                        case 'system': res = 'WebOS Kernel 3.0.0-Ultimate. Hybrid Architecture. All systems nominal.'; break;
                        case 'exit': closeWindow('terminal'); break;
                        case 'neofetch': 
                            res = `<div class="flex items-start text-xs"><div class="text-sky-400 font-mono mr-5 leading-tight">  _  _  <br> | || | <br> | || | <br> |_||_| <br>  v3.0  </div><div><span class="text-sky-400 font-bold">admin@WebOS</span><br><span class="text-zinc-600">-----------</span><br>OS: WebOS Ultimate V3.0<br>Uptime: 1m 32s<br>Packages: 7 (FS-Hybrid)<br>Memory: 1024MB / 16384MB<br>UI: Fluent Glass</div></div>`;
                            break;
                        default: res = cmd ? `sh: command not found: ${cmd}` : '';
                    }
                    if (res) output.innerHTML += `<div class="mb-1 text-zinc-400 ml-2">${res}</div>`;
                    input.value = '';
                    body.scrollTop = body.scrollHeight;
                }
            });
            input.focus();
        }

        // --- Explorer Logic ---
        let explorerHistory = ['C:'];
        
        function getPointerDir() {
            let dir = state.fs.root;
            for(let key of explorerHistory) dir = dir[key].children;
            return dir;
        }

        function updateExplorer() {
            const container = document.getElementById('explorer-content');
            const pathEl = document.getElementById('explorer-path');
            const pasteBtn = document.getElementById('explorer-paste');
            if(!container) return;

            pathEl.textContent = explorerHistory.join('/');
            if (state.clipboard) pasteBtn.classList.remove('hidden');
            else pasteBtn.classList.add('hidden');

            const currentDir = getPointerDir();

            container.innerHTML = '';
            Object.entries(currentDir).forEach(([name, info]) => {
                const item = document.createElement('div');
                item.className = 'flex flex-col items-center group cursor-pointer p-3 rounded-xl hover:bg-gray-100 transition-all relative';
                
                item.innerHTML = `
                    <div class="absolute top-1 right-1 flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="fsDelete(event, '${name}')" class="p-1 hover:bg-rose-100 rounded text-rose-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        <button onclick="fsRename(event, '${name}')" class="p-1 hover:bg-blue-100 rounded text-blue-500"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        <button onclick="fsCopy(event, '${name}')" class="p-1 hover:bg-emerald-100 rounded text-emerald-500"><i data-lucide="copy" class="w-3 h-3"></i></button>
                    </div>
                    <div class="w-10 h-10 flex items-center justify-center mb-1">
                        <i data-lucide="${info.type === 'dir' ? 'folder' : 'file-text'}" 
                           class="w-8 h-8 ${info.type === 'dir' ? 'text-yellow-400 fill-yellow-400/10' : 'text-sky-400 fill-sky-400/10'}"></i>
                    </div>
                    <span class="text-[9px] font-bold text-gray-600 text-center break-all line-clamp-2 w-full px-1">${name}</span>
                `;

                item.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    if(info.type === 'dir') {
                        explorerHistory.push(name);
                        updateExplorer();
                    } else {
                        openWindow('notepad', info.content);
                    }
                };
                container.appendChild(item);
            });
            lucide.createIcons();
        }

        function fsNew(type) {
            const name = prompt(`Введите имя ${type === 'dir' ? 'папки' : 'файла'}:`, `New ${type === 'dir' ? 'Folder' : 'File'}`);
            if(!name) return;
            const dir = getPointerDir();
            if(dir[name]) return showToast('Имя уже занято', 'alert-circle');
            dir[name] = type === 'dir' ? { type: 'dir', children: {} } : { type: 'file', content: '' };
            updateExplorer();
            showToast('Создано', 'check');
        }

        function fsDelete(e, name) {
            e.stopPropagation();
            const dir = getPointerDir();
            delete dir[name];
            updateExplorer();
            showToast('Удалено', 'trash');
        }

        function fsRename(e, name) {
            e.stopPropagation();
            const newName = prompt('Переименовать в:', name);
            if(!newName || newName === name) return;
            const dir = getPointerDir();
            dir[newName] = dir[name];
            delete dir[name];
            updateExplorer();
        }

        function fsCopy(e, name) {
            e.stopPropagation();
            const dir = getPointerDir();
            state.clipboard = { name, info: JSON.parse(JSON.stringify(dir[name])) };
            updateExplorer();
            showToast('Скопировано', 'copy');
        }

        function fsPaste() {
            if(!state.clipboard) return;
            const dir = getPointerDir();
            let newName = state.clipboard.name;
            if (dir[newName]) newName += ' (Copy)';
            dir[newName] = JSON.parse(JSON.stringify(state.clipboard.info));
            updateExplorer();
            showToast('Вставлено', 'check');
        }

        function navigateBack() {
            if(explorerHistory.length > 1) {
                explorerHistory.pop();
                updateExplorer();
            }
        }

        // --- Notepad Logic ---
        function saveNotepad() {
            const text = document.getElementById('notepad-text').value;
            localStorage.setItem('webos_notepad', text);
            showToast('Документ успешно сохранен!', 'check-circle');
        }

        // --- Browser Logic ---
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            const frame = document.getElementById('browser-frame');
            frame.src = url.startsWith('http') ? url : 'https://' + url;
        }

        // --- Paint Logic ---
        function initPaint() {
            const canvas = document.getElementById('paint-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const colorPicker = document.getElementById('paint-color');
            const sizePicker = document.getElementById('paint-size');
            let drawing = false;

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { 
                    x: (clientX - rect.left) * scaleX, 
                    y: (clientY - rect.top) * scaleY 
                };
            };

            const start = (e) => {
                drawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                ctx.lineWidth = sizePicker.value;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = colorPicker.value;
                
                // For small screens, allow drawing but don't prevent all touch defaults
                if (e.type === 'touchstart' && e.target === canvas) e.preventDefault();
            };

            const move = (e) => {
                if (!drawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                if (e.type === 'touchmove') e.preventDefault();
            };

            const stop = () => { drawing = false; ctx.closePath(); };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('touchstart', start, {passive: false});
            
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move, {passive: false});
            
            window.addEventListener('mouseup', stop);
            window.addEventListener('touchend', stop);
        }

        function clearPaint() {
            const canvas = document.getElementById('paint-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('Холст очищен', 'trash-2');
        }

        function savePaint() {
            const canvas = document.getElementById('paint-canvas');
            try {
                const link = document.createElement('a');
                link.download = 'webos-drawing.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('Рисунок сохранен', 'download');
            } catch (err) {
                showToast('Ошибка сохранения', 'alert-triangle');
            }
        }

        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const GRID = getGridSize();
                state.icons.forEach(icon => {
                    const maxX = window.innerWidth - GRID;
                    const maxY = window.innerHeight - (GRID * 2.5);
                    icon.x = Math.max(getGridOffsetX(), Math.min(maxX, Math.round((icon.x - getGridOffsetX()) / GRID) * GRID + getGridOffsetX()));
                    icon.y = Math.max(getGridOffsetY(), Math.min(maxY, Math.round((icon.y - getGridOffsetY()) / GRID) * GRID + getGridOffsetY()));
                });
                renderIcons();
            }, 250);
        });
    </script>
</body>
</html>
