<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com blob: data:;">
    <title>Game Max Portal - Retro Console Gaming</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Press+Start+2P&display=swap');
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .retro-font { font-family: 'Press Start 2P', cursive; }
        
        .crt-overlay {
            pointer-events: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.15),
                rgba(0,0,0,0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .crt-active .crt-overlay { opacity: 1; }
        
        .glow-ps2 { box-shadow: 0 0 20px #e94560, 0 0 40px #e94560; }
        .glow-ps3 { box-shadow: 0 0 30px #4fc3f7, 0 0 60px #4fc3f7; }
        .glow-ps4 { box-shadow: 0 0 40px #2196f3, 0 0 80px #1565c0; }
        
        .console-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        .console-card:hover {
            transform: translateY(-20px) rotateX(5deg) scale(1.05);
        }
        
        .game-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .game-card:hover {
            transform: scale(1.08);
            z-index: 10;
        }
        
        .locked-overlay {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        
        .points-counter {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes coinSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        
        .coin-spin { animation: coinSpin 1s ease-out; }
        
        .modal-backdrop {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
        }
        
        .badge-pro {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
        }
        
        .badge-proplus {
            background: linear-gradient(135deg, #2196f3, #1565c0);
        }
        
        .upload-zone {
            border: 3px dashed #666;
            transition: all 0.3s;
        }
        
        .upload-zone.dragover {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }
        
        .genre-tag {
            font-size: 0.65rem;
            padding: 2px 8px;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .health-bar {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }
        
        .enemy-health {
            background: linear-gradient(90deg, #f44336, #ff5722);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake { animation: shake 0.3s; }
        
        @keyframes pointsFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        .points-float {
            animation: pointsFloat 1s ease-out forwards;
        }
    </style>
</head>
<body class="text-white">
    <div class="crt-overlay"></div>
    
    <!-- Main Hub -->
    <div id="main-hub" class="min-h-screen">
        <header class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-lg border-b border-gray-800">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-xl font-black">G</span>
                    </div>
                    <h1 class="text-xl font-black tracking-wider">GAME MAX PORTAL</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div id="subscription-badges" class="flex gap-2"></div>
                    <div class="points-counter bg-gradient-to-r from-yellow-600 to-amber-500 px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer" onclick="showShop()">
                        <span class="text-2xl">ü™ô</span>
                        <span id="points-display" class="font-bold text-lg">0</span>
                        <span class="text-xs opacity-80">PTS</span>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-lg">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-sm">üë§</div>
                        <span class="text-sm">Player</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="pt-24 pb-12 px-4">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-black mb-4 bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent">
                    SELECT YOUR CONSOLE
                </h2>
                <p class="text-gray-400 text-lg">Experience gaming across three generations</p>
            </div>

            <div class="container mx-auto grid md:grid-cols-3 gap-8 max-w-6xl">
                <!-- Game Max 1 Pro -->
                <div class="console-card bg-gradient-to-br from-[#1a1a2e] to-[#16213e] rounded-2xl p-6 border border-[#e94560]/30 glow-ps2 cursor-pointer" onclick="openPlatform('1pro')">
                    <div class="relative mb-4">
                        <div id="preview-1pro" class="w-full h-48 bg-black rounded-lg overflow-hidden"></div>
                        <div class="absolute top-2 right-2 bg-[#e94560] px-2 py-1 rounded text-xs font-bold">PS2 ERA</div>
                    </div>
                    <h3 class="text-2xl font-black text-[#e94560] mb-2">GAME MAX 1 PRO</h3>
                    <p class="text-gray-400 text-sm mb-4">Classic retro gaming ‚Ä¢ Low-poly visuals ‚Ä¢ CRT effects</p>
                    <div class="flex flex-wrap gap-1 mb-4">
                        <span class="genre-tag bg-red-900/50 rounded px-2 py-1">Racing</span>
                        <span class="genre-tag bg-green-900/50 rounded px-2 py-1">Adventure</span>
                        <span class="genre-tag bg-blue-900/50 rounded px-2 py-1">Sports</span>
                        <span class="genre-tag bg-purple-900/50 rounded px-2 py-1">FPS</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">8 Games</span>
                        <span class="text-[#e94560] font-bold">FREE</span>
                    </div>
                </div>

                <!-- Game Max 2 Pro -->
                <div class="console-card bg-gradient-to-br from-[#16213e] to-[#0f3460] rounded-2xl p-6 border border-[#4fc3f7]/30 glow-ps3 cursor-pointer" onclick="openPlatform('2pro')">
                    <div class="relative mb-4">
                        <div id="preview-2pro" class="w-full h-48 bg-black rounded-lg overflow-hidden"></div>
                        <div class="absolute top-2 right-2 bg-[#4fc3f7] text-black px-2 py-1 rounded text-xs font-bold">PS3 ERA</div>
                    </div>
                    <h3 class="text-2xl font-black text-[#4fc3f7] mb-2">GAME MAX 2 PRO</h3>
                    <p class="text-gray-400 text-sm mb-4">Enhanced graphics ‚Ä¢ Normal mapping ‚Ä¢ Bloom effects</p>
                    <div class="flex flex-wrap gap-1 mb-4">
                        <span class="genre-tag bg-red-900/50 rounded px-2 py-1">Racing</span>
                        <span class="genre-tag bg-green-900/50 rounded px-2 py-1">Sports</span>
                        <span class="genre-tag bg-blue-900/50 rounded px-2 py-1">Action</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">6 Free + 10 Pro</span>
                        <span class="text-yellow-400 font-bold">üîí PRO: 900 pts</span>
                    </div>
                </div>

                <!-- Game Max 3 -->
                <div class="console-card bg-gradient-to-br from-[#0a0a0a] to-[#1a237e] rounded-2xl p-6 border border-[#2196f3]/30 glow-ps4 cursor-pointer" onclick="openPlatform('3')">
                    <div class="relative mb-4">
                        <div id="preview-3" class="w-full h-48 bg-black rounded-lg overflow-hidden"></div>
                        <div class="absolute top-2 right-2 bg-[#2196f3] px-2 py-1 rounded text-xs font-bold">PS4 ERA</div>
                    </div>
                    <h3 class="text-2xl font-black text-[#2196f3] mb-2">GAME MAX 3</h3>
                    <p class="text-gray-400 text-sm mb-4">PBR materials ‚Ä¢ Dynamic lighting ‚Ä¢ HDR rendering</p>
                    <div class="flex flex-wrap gap-1 mb-4">
                        <span class="genre-tag bg-red-900/50 rounded px-2 py-1">Racing</span>
                        <span class="genre-tag bg-green-900/50 rounded px-2 py-1">FPS</span>
                        <span class="genre-tag bg-blue-900/50 rounded px-2 py-1">Fighting</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">6 Free + 3 Pro+</span>
                        <span class="text-blue-400 font-bold">üîí PRO+: 1200 pts</span>
                    </div>
                </div>
            </div>

            <div class="container mx-auto max-w-4xl mt-12 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-900/50 rounded-xl p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">üéÆ</div>
                    <div class="text-2xl font-bold" id="total-games">26</div>
                    <div class="text-xs text-gray-500">Total Games</div>
                </div>
                <div class="bg-gray-900/50 rounded-xl p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">üèÜ</div>
                    <div class="text-2xl font-bold" id="games-completed">0</div>
                    <div class="text-xs text-gray-500">Completed</div>
                </div>
                <div class="bg-gray-900/50 rounded-xl p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">üì§</div>
                    <div class="text-2xl font-bold" id="uploaded-count">0</div>
                    <div class="text-xs text-gray-500">Uploaded</div>
                </div>
                <div class="bg-gray-900/50 rounded-xl p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">‚≠ê</div>
                    <div class="text-2xl font-bold" id="total-points">0</div>
                    <div class="text-xs text-gray-500">Total Earned</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Platform Dashboard -->
    <div id="platform-dashboard" class="min-h-screen hidden">
        <header class="fixed top-0 left-0 right-0 z-50 bg-black/90 backdrop-blur-lg border-b border-gray-800">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button onclick="goHome()" class="bg-gray-800 hover:bg-gray-700 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <h1 id="platform-title" class="text-xl font-black"></h1>
                </div>
                <div class="flex items-center gap-4">
                    <input type="text" id="search-input" placeholder="Search games..." 
                        class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 w-48">
                    <button onclick="showUploadModal()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition">
                        <span>üì§</span> Add Game
                    </button>
                    <div class="points-counter bg-gradient-to-r from-yellow-600 to-amber-500 px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer" onclick="showShop()">
                        <span>ü™ô</span>
                        <span id="points-display-2" class="font-bold">0</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="subscription-banner" class="fixed top-16 left-0 right-0 z-40 hidden">
            <div class="bg-gradient-to-r from-purple-900/90 to-blue-900/90 backdrop-blur py-3 px-4 text-center">
                <span id="sub-banner-text" class="font-bold"></span>
                <button onclick="showShop()" class="ml-4 bg-yellow-500 text-black px-4 py-1 rounded-full text-sm font-bold hover:bg-yellow-400 transition">
                    Unlock Now
                </button>
            </div>
        </div>

        <div class="fixed top-32 left-0 right-0 z-30 bg-gray-900/80 backdrop-blur py-2 px-4 border-b border-gray-800">
            <div class="container mx-auto flex gap-2 overflow-x-auto scrollbar-hide" id="genre-filter"></div>
        </div>

        <main class="pt-44 pb-12 px-4">
            <div class="container mx-auto" id="games-grid"></div>
        </main>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <header class="bg-gray-900/90 backdrop-blur border-b border-gray-800 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="exitGame()" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-lg font-bold transition flex items-center gap-2">
                    <span>‚úï</span> Exit
                </button>
                <div>
                    <h2 id="game-title" class="text-xl font-bold"></h2>
                    <span id="game-genre-display" class="text-sm text-gray-400"></span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="game-controls-hint" class="text-sm text-gray-400"></div>
            </div>
        </header>
        <div id="game-container" class="flex-1 relative">
            <canvas id="game-canvas"></canvas>
            <div id="game-ui" class="absolute top-4 left-4 text-white">
                <div class="bg-black/70 backdrop-blur rounded-lg px-4 py-3 space-y-2">
                    <div class="flex items-center gap-2">
                        <span>üèÜ</span>
                        <span>Score: <span id="game-score" class="font-bold text-yellow-400">0</span></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>üìä</span>
                        <span>Level: <span id="game-level" class="font-bold text-cyan-400">1</span></span>
                    </div>
                    <div id="health-container" class="hidden">
                        <div class="flex items-center gap-2">
                            <span>‚ù§Ô∏è</span>
                            <div class="w-24 h-3 bg-gray-700 rounded-full overflow-hidden">
                                <div id="health-bar" class="health-bar h-full" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="timer-container" class="hidden flex items-center gap-2">
                        <span>‚è±Ô∏è</span>
                        <span>Time: <span id="game-timer" class="font-bold text-green-400">60</span>s</span>
                    </div>
                </div>
            </div>
            <div id="game-instructions" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur rounded-lg px-6 py-3 text-center">
                <div id="instructions-text" class="text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Complete Modal -->
    <div id="complete-modal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-8 max-w-md w-full mx-4 border border-gray-700 text-center">
            <div id="complete-icon" class="text-6xl mb-4">üèÜ</div>
            <h2 id="complete-title" class="text-3xl font-black mb-2">GAME COMPLETE!</h2>
            <p class="text-gray-400 mb-6" id="complete-message">Amazing performance!</p>
            <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-xl p-6 mb-6">
                <div class="text-yellow-400 text-lg mb-2">Points Earned</div>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-4xl coin-spin">ü™ô</span>
                    <span id="earned-points" class="text-5xl font-black text-yellow-400">50</span>
                </div>
                <div id="bonus-text" class="text-green-400 text-sm mt-2"></div>
            </div>
            <div class="text-sm text-gray-400 mb-4">
                Your balance: <span id="new-balance" class="text-yellow-400 font-bold">0</span> points
            </div>
            <button onclick="closeCompleteModal()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 py-3 rounded-xl font-bold text-lg transition">
                Continue
            </button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4 border border-gray-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">Upload Your Game</h2>
                <button onclick="closeUploadModal()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <div id="upload-zone" class="upload-zone rounded-xl p-12 text-center mb-6">
                <div class="text-6xl mb-4">üìÅ</div>
                <h3 class="text-xl font-bold mb-2">Drag & Drop ZIP File</h3>
                <p class="text-gray-400 mb-4">or click to browse</p>
                <input type="file" id="file-input" accept=".zip" class="hidden">
                <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold transition">
                    Browse Files
                </button>
            </div>

            <div id="upload-form" class="hidden space-y-4">
                <input type="text" id="game-name-input" placeholder="Game Title" 
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
                <select id="game-genre-input" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
                    <option value="">Select Genre</option>
                    <option value="Racing">Racing</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Sports">Sports</option>
                    <option value="FPS">FPS</option>
                    <option value="Action">Action</option>
                    <option value="Strategy">Strategy</option>
                    <option value="Platformer">Platformer</option>
                    <option value="Fighting">Fighting</option>
                </select>
                <button onclick="publishGame()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 py-3 rounded-xl font-bold text-lg transition">
                    üöÄ Publish Game
                </button>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-3xl w-full mx-4 border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">üõí Subscription Shop</h2>
                <button onclick="closeShop()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>

            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-yellow-900/30 px-6 py-3 rounded-full">
                    <span class="text-2xl">ü™ô</span>
                    <span class="text-2xl font-bold text-yellow-400" id="shop-points">0</span>
                    <span class="text-gray-400">points available</span>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div id="pro-card" class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-6 border-2 border-green-600/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-2xl">üéÆ</div>
                        <div>
                            <h3 class="text-xl font-bold text-green-400">Game Max Pro</h3>
                            <p class="text-sm text-gray-400">For Game Max 2 Pro</p>
                        </div>
                    </div>
                    <ul class="text-sm text-gray-300 space-y-2 mb-6">
                        <li>‚úì 10 Exclusive PS3-style games</li>
                        <li>‚úì Normal mapping support</li>
                        <li>‚úì Enhanced bloom effects</li>
                        <li>‚úì Green Pro badge</li>
                    </ul>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ü™ô</span>
                            <span class="text-2xl font-bold">900</span>
                        </div>
                        <button id="buy-pro-btn" onclick="buySubscription('pro')" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-lg font-bold transition">
                            Buy Now
                        </button>
                    </div>
                </div>

                <div id="proplus-card" class="bg-gradient-to-br from-blue-900/50 to-indigo-900/50 rounded-xl p-6 border-2 border-blue-600/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-2xl">‚≠ê</div>
                        <div>
                            <h3 class="text-xl font-bold text-blue-400">Game Max Pro+</h3>
                            <p class="text-sm text-gray-400">For Game Max 3</p>
                        </div>
                    </div>
                    <ul class="text-sm text-gray-300 space-y-2 mb-6">
                        <li>‚úì 3 Exclusive PS4-style games</li>
                        <li>‚úì Full PBR materials</li>
                        <li>‚úì 4K texture support</li>
                        <li>‚úì Blue Pro+ badge</li>
                    </ul>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ü™ô</span>
                            <span class="text-2xl font-bold">1200</span>
                        </div>
                        <button id="buy-proplus-btn" onclick="buySubscription('pro+')" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold transition">
                            Buy Now
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center text-gray-500 text-sm">
                üí° Earn points by completing games! Base: 50 pts, Perfect Run: +20 pts bonus
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const DEFAULT_DATA = {
            user: {
                points: 50,
                totalEarned: 50,
                subscriptions: [],
                gamesCompleted: 0
            },
            games: {
                "1pro": [
                    { id: "retro_racer", title: "Retro Racer", genre: "Racing", points: 50, exclusive: false },
                    { id: "dungeon_quest", title: "Dungeon Quest", genre: "Adventure", points: 50, exclusive: false },
                    { id: "pixel_soccer", title: "Pixel Soccer", genre: "Sports", points: 50, exclusive: false },
                    { id: "corridor_shooter", title: "Corridor Shooter", genre: "FPS", points: 50, exclusive: false },
                    { id: "arena_fighter", title: "Arena Fighter", genre: "Fighting", points: 50, exclusive: false },
                    { id: "survival_island", title: "Survival Island", genre: "Survival", points: 50, exclusive: false },
                    { id: "block_builder", title: "Block Builder", genre: "Building", points: 50, exclusive: false },
                    { id: "war_tactics", title: "War Tactics", genre: "Strategy", points: 50, exclusive: false }
                ],
                "2pro": [
                    { id: "speed_rush", title: "Speed Rush", genre: "Racing", points: 50, exclusive: false },
                    { id: "striker_pro", title: "Striker Pro", genre: "Sports", points: 50, exclusive: false },
                    { id: "city_builder", title: "City Builder", genre: "Building", points: 50, exclusive: false },
                    { id: "shadow_ops", title: "Shadow Ops", genre: "Action", points: 50, exclusive: false },
                    { id: "market_tycoon", title: "Market Tycoon", genre: "Economic", points: 50, exclusive: false },
                    { id: "quest_realm", title: "Quest Realm", genre: "Adventure", points: 50, exclusive: false },
                    { id: "turbo_gt", title: "Turbo GT", genre: "Racing", points: 60, exclusive: true },
                    { id: "champions_league", title: "Champions League", genre: "Sports", points: 60, exclusive: true },
                    { id: "elite_force", title: "Elite Force", genre: "Action", points: 60, exclusive: true },
                    { id: "mega_structures", title: "Mega Structures", genre: "Building", points: 60, exclusive: true },
                    { id: "global_markets", title: "Global Markets", genre: "Economic", points: 60, exclusive: true },
                    { id: "legends_quest", title: "Legends Quest", genre: "Adventure", points: 60, exclusive: true },
                    { id: "night_drift", title: "Night Drift", genre: "Racing", points: 60, exclusive: true },
                    { id: "basketball_stars", title: "Basketball Stars", genre: "Sports", points: 60, exclusive: true },
                    { id: "cyber_warriors", title: "Cyber Warriors", genre: "Action", points: 60, exclusive: true },
                    { id: "space_station", title: "Space Station", genre: "Building", points: 60, exclusive: true }
                ],
                "3": [
                    { id: "hyper_drive", title: "Hyper Drive", genre: "Racing", points: 50, exclusive: false },
                    { id: "combat_zone", title: "Combat Zone", genre: "Action", points: 50, exclusive: false },
                    { id: "tactical_ops", title: "Tactical Ops", genre: "FPS", points: 50, exclusive: false },
                    { id: "battle_arena", title: "Battle Arena", genre: "Fighting", points: 50, exclusive: false },
                    { id: "empire_wars", title: "Empire Wars", genre: "Strategy", points: 50, exclusive: false },
                    { id: "sky_jumper", title: "Sky Jumper", genre: "Platformer", points: 50, exclusive: false },
                    { id: "apex_racer", title: "Apex Racer", genre: "Racing", points: 70, exclusive: true },
                    { id: "omega_strike", title: "Omega Strike", genre: "FPS", points: 70, exclusive: true },
                    { id: "champions_arena", title: "Champions Arena", genre: "Fighting", points: 70, exclusive: true }
                ]
            },
            uploadedGames: []
        };

        let gameData = JSON.parse(localStorage.getItem('gameMaxPortal')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
        let currentPlatform = null;
        let currentGame = null;
        let gameScene, gameRenderer, gameCamera, gameAnimationId;
        let gameScore = 0, gameLevel = 1, playerHealth = 100, gameTimer = 60;
        let playerMesh, enemies = [], collectibles = [], projectiles = [];
        let playerPos = { x: 0, y: 0, z: 0 };
        let keys = {};
        let gameActive = false;
        let perfectRun = true;

        // ==================== INIT ====================
        function init() {
            updateUI();
            initPreviews();
            setupEvents();
        }

        function saveData() {
            localStorage.setItem('gameMaxPortal', JSON.stringify(gameData));
            updateUI();
        }

        function updateUI() {
            document.getElementById('points-display').textContent = gameData.user.points;
            document.getElementById('points-display-2').textContent = gameData.user.points;
            document.getElementById('shop-points').textContent = gameData.user.points;
            document.getElementById('total-points').textContent = gameData.user.totalEarned;
            document.getElementById('games-completed').textContent = gameData.user.gamesCompleted;
            document.getElementById('uploaded-count').textContent = gameData.uploadedGames.length;

            const badges = document.getElementById('subscription-badges');
            badges.innerHTML = '';
            if (gameData.user.subscriptions.includes('pro')) {
                badges.innerHTML += '<span class="badge-pro px-2 py-1 rounded text-xs font-bold">PRO</span>';
            }
            if (gameData.user.subscriptions.includes('pro+')) {
                badges.innerHTML += '<span class="badge-proplus px-2 py-1 rounded text-xs font-bold">PRO+</span>';
            }

            updateShopButtons();
        }

        function updateShopButtons() {
            const proBtn = document.getElementById('buy-pro-btn');
            const proplusBtn = document.getElementById('buy-proplus-btn');
            
            if (gameData.user.subscriptions.includes('pro')) {
                proBtn.textContent = '‚úì Owned';
                proBtn.disabled = true;
                proBtn.className = 'bg-gray-600 px-6 py-2 rounded-lg font-bold cursor-not-allowed';
            } else if (gameData.user.points >= 900) {
                proBtn.textContent = 'Buy Now';
                proBtn.disabled = false;
                proBtn.className = 'bg-green-600 hover:bg-green-500 px-6 py-2 rounded-lg font-bold transition cursor-pointer';
            } else {
                proBtn.textContent = `Need ${900 - gameData.user.points} more`;
                proBtn.disabled = true;
                proBtn.className = 'bg-gray-600 px-6 py-2 rounded-lg font-bold cursor-not-allowed';
            }

            if (gameData.user.subscriptions.includes('pro+')) {
                proplusBtn.textContent = '‚úì Owned';
                proplusBtn.disabled = true;
                proplusBtn.className = 'bg-gray-600 px-6 py-2 rounded-lg font-bold cursor-not-allowed';
            } else if (gameData.user.points >= 1200) {
                proplusBtn.textContent = 'Buy Now';
                proplusBtn.disabled = false;
                proplusBtn.className = 'bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold transition cursor-pointer';
            } else {
                proplusBtn.textContent = `Need ${1200 - gameData.user.points} more`;
                proplusBtn.disabled = true;
                proplusBtn.className = 'bg-gray-600 px-6 py-2 rounded-lg font-bold cursor-not-allowed';
            }
        }

        // ==================== PREVIEWS ====================
        function initPreviews() {
            createPreview('preview-1pro', 'ps2');
            createPreview('preview-2pro', 'ps3');
            createPreview('preview-3', 'ps4');
        }

        function createPreview(id, style) {
            const container = document.getElementById(id);
            if (!container) return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: style !== 'ps2' });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0x111111);
            container.appendChild(renderer.domElement);

            let mesh;
            if (style === 'ps2') {
                const geo = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                const mat = new THREE.MeshBasicMaterial({ color: 0xe94560 });
                mesh = new THREE.Mesh(geo, mat);
                scene.add(mesh);
            } else if (style === 'ps3') {
                const geo = new THREE.IcosahedronGeometry(1.2, 1);
                const mat = new THREE.MeshPhongMaterial({ color: 0x4fc3f7, shininess: 100 });
                mesh = new THREE.Mesh(geo, mat);
                scene.add(mesh);
                scene.add(new THREE.PointLight(0x4fc3f7, 2, 100));
                scene.add(new THREE.AmbientLight(0x333333));
            } else {
                const geo = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
                const mat = new THREE.MeshStandardMaterial({ color: 0x2196f3, metalness: 0.8, roughness: 0.2 });
                mesh = new THREE.Mesh(geo, mat);
                scene.add(mesh);
                scene.add(new THREE.PointLight(0x2196f3, 2));
                scene.add(new THREE.AmbientLight(0x222222));
            }

            camera.position.z = 4;
            function animate() {
                requestAnimationFrame(animate);
                mesh.rotation.x += 0.005;
                mesh.rotation.y += 0.01;
                renderer.render(scene, camera);
            }
            animate();
        }

        // ==================== NAVIGATION ====================
        function openPlatform(platform) {
            currentPlatform = platform;
            document.getElementById('main-hub').classList.add('hidden');
            document.getElementById('platform-dashboard').classList.remove('hidden');
            document.getElementById('platform-title').textContent = {
                '1pro': 'GAME MAX 1 PRO', '2pro': 'GAME MAX 2 PRO', '3': 'GAME MAX 3'
            }[platform];

            if (platform === '1pro') document.body.classList.add('crt-active');
            else document.body.classList.remove('crt-active');

            const banner = document.getElementById('subscription-banner');
            if (platform === '2pro' && !gameData.user.subscriptions.includes('pro')) {
                banner.classList.remove('hidden');
                document.getElementById('sub-banner-text').textContent = 'üîì Unlock 10 exclusive games with Game Max Pro (900 pts)';
            } else if (platform === '3' && !gameData.user.subscriptions.includes('pro+')) {
                banner.classList.remove('hidden');
                document.getElementById('sub-banner-text').textContent = 'üîì Unlock 3 exclusive games with Game Max Pro+ (1200 pts)';
            } else {
                banner.classList.add('hidden');
            }

            renderGenreFilter();
            renderGames();
        }

        function goHome() {
            document.getElementById('main-hub').classList.remove('hidden');
            document.getElementById('platform-dashboard').classList.add('hidden');
            document.body.classList.remove('crt-active');
        }

        // ==================== GAMES GRID ====================
        function renderGenreFilter() {
            const games = [...gameData.games[currentPlatform], ...gameData.uploadedGames.filter(g => g.platform === currentPlatform)];
            const genres = ['All', ...new Set(games.map(g => g.genre))];
            document.getElementById('genre-filter').innerHTML = genres.map((g, i) => `
                <button onclick="filterByGenre('${g}')" class="genre-btn px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition ${i === 0 ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}">
                    ${g}
                </button>
            `).join('');
        }

        function filterByGenre(genre) {
            document.querySelectorAll('.genre-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-800');
                if (btn.textContent.trim() === genre) {
                    btn.classList.remove('bg-gray-800');
                    btn.classList.add('bg-blue-600');
                }
            });
            renderGames(genre === 'All' ? null : genre);
        }

        function renderGames(genreFilter = null) {
            let games = [...gameData.games[currentPlatform], ...gameData.uploadedGames.filter(g => g.platform === currentPlatform)];
            if (genreFilter) games = games.filter(g => g.genre === genreFilter);

            const search = document.getElementById('search-input').value.toLowerCase();
            if (search) games = games.filter(g => g.title.toLowerCase().includes(search));

            const colors = {
                '1pro': { bg: 'from-red-900/50 to-pink-900/50', border: 'border-red-600/30', accent: 'text-red-400' },
                '2pro': { bg: 'from-cyan-900/50 to-blue-900/50', border: 'border-cyan-600/30', accent: 'text-cyan-400' },
                '3': { bg: 'from-blue-900/50 to-indigo-900/50', border: 'border-blue-600/30', accent: 'text-blue-400' }
            }[currentPlatform];

            const icons = { Racing: 'üèéÔ∏è', Adventure: 'üó∫Ô∏è', Sports: '‚öΩ', FPS: 'üî´', Fighting: 'ü•ä', Survival: 'üèïÔ∏è', Building: 'üèóÔ∏è', Strategy: '‚ôüÔ∏è', Action: 'üí•', Economic: 'üí∞', Platformer: 'ü¶ò' };

            document.getElementById('games-grid').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    ${games.map(game => {
                        const locked = game.exclusive && !hasAccess(game);
                        return `
                            <div class="game-card bg-gradient-to-br ${colors.bg} rounded-xl overflow-hidden border ${colors.border} relative"
                                onclick="${locked ? 'showShop()' : `launchGame('${game.id}')`}">
                                <div class="aspect-video bg-black/50 flex items-center justify-center relative">
                                    <span class="text-5xl">${icons[game.genre] || 'üéÆ'}</span>
                                    ${locked ? '<div class="locked-overlay absolute inset-0 flex items-center justify-center"><span class="text-4xl">üîí</span></div>' : ''}
                                    ${game.exclusive ? `<div class="absolute top-2 right-2 ${currentPlatform === '2pro' ? 'bg-green-600' : 'bg-blue-600'} px-2 py-0.5 rounded text-xs font-bold">${currentPlatform === '2pro' ? 'PRO' : 'PRO+'}</div>` : ''}
                                    ${game.uploaded ? '<div class="absolute top-2 left-2 bg-purple-600 px-2 py-0.5 rounded text-xs font-bold">USER</div>' : ''}
                                </div>
                                <div class="p-3">
                                    <h3 class="font-bold text-sm mb-1 truncate">${game.title}</h3>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs bg-gray-800 px-2 py-0.5 rounded">${game.genre}</span>
                                        <span class="${colors.accent} text-xs font-bold">+${game.points} pts</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function hasAccess(game) {
            if (!game.exclusive) return true;
            if (currentPlatform === '2pro') return gameData.user.subscriptions.includes('pro');
            if (currentPlatform === '3') return gameData.user.subscriptions.includes('pro+');
            return true;
        }

        // ==================== GAME ENGINE ====================
        function launchGame(gameId) {
            const allGames = [...gameData.games[currentPlatform], ...gameData.uploadedGames.filter(g => g.platform === currentPlatform)];
            currentGame = allGames.find(g => g.id === gameId);
            if (!currentGame) return;

            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-title').textContent = currentGame.title;
            document.getElementById('game-genre-display').textContent = currentGame.genre;

            gameScore = 0;
            gameLevel = 1;
            playerHealth = 100;
            gameTimer = 60;
            perfectRun = true;
            enemies = [];
            collectibles = [];
            projectiles = [];
            playerPos = { x: 0, y: 0, z: 0 };
            gameActive = true;

            initGameByGenre();
        }

        function initGameByGenre() {
            const container = document.getElementById('game-container');
            const canvas = document.getElementById('game-canvas');

            if (gameRenderer) gameRenderer.dispose();
            if (gameAnimationId) cancelAnimationFrame(gameAnimationId);

            gameScene = new THREE.Scene();
            gameCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            gameRenderer = new THREE.WebGLRenderer({ canvas, antialias: currentPlatform !== '1pro' });
            gameRenderer.setSize(container.clientWidth, container.clientHeight);

            const genre = currentGame.genre;
            
            // Configure UI based on genre
            document.getElementById('health-container').classList.add('hidden');
            document.getElementById('timer-container').classList.add('hidden');

            if (genre === 'Racing') setupRacingGame();
            else if (genre === 'FPS' || genre === 'Action') setupShooterGame();
            else if (genre === 'Fighting') setupFightingGame();
            else if (genre === 'Sports') setupSportsGame();
            else if (genre === 'Adventure' || genre === 'Survival') setupAdventureGame();
            else if (genre === 'Platformer') setupPlatformerGame();
            else if (genre === 'Strategy' || genre === 'Economic' || genre === 'Building') setupStrategyGame();
            else setupDefaultGame();

            setupGameInput();
            gameLoop();
        }

        // ==================== RACING GAME ====================
        function setupRacingGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è to steer ‚Ä¢ Avoid obstacles ‚Ä¢ Reach 1000 points!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrow Keys to steer';
            
            gameScene.background = new THREE.Color(currentPlatform === '1pro' ? 0x1a1a2e : currentPlatform === '2pro' ? 0x16213e : 0x0a0a0a);

            // Lighting
            if (currentPlatform !== '1pro') {
                gameScene.add(new THREE.AmbientLight(0x404040));
                const light = new THREE.PointLight(0xffffff, 1, 100);
                light.position.set(0, 10, 5);
                gameScene.add(light);
            }

            // Player car
            const carGeo = new THREE.BoxGeometry(1, 0.5, 2);
            const carMat = getMaterial(0x00ff00);
            playerMesh = new THREE.Mesh(carGeo, carMat);
            playerMesh.position.y = 0.25;
            gameScene.add(playerMesh);

            // Road
            const roadGeo = new THREE.PlaneGeometry(8, 200);
            const roadMat = getMaterial(0x333333);
            const road = new THREE.Mesh(roadGeo, roadMat);
            road.rotation.x = -Math.PI / 2;
            road.position.z = -90;
            gameScene.add(road);

            // Spawn obstacles
            for (let i = 0; i < 10; i++) {
                spawnRacingObstacle(-20 - i * 20);
            }

            gameCamera.position.set(0, 5, 8);
            gameCamera.lookAt(0, 0, -10);
        }

        function spawnRacingObstacle(z) {
            const geo = new THREE.BoxGeometry(1.5, 1, 1.5);
            const mat = getMaterial(Math.random() > 0.5 ? 0xff0000 : 0xff6600);
            const obs = new THREE.Mesh(geo, mat);
            obs.position.set((Math.random() - 0.5) * 6, 0.5, z);
            obs.userData = { type: 'obstacle' };
            gameScene.add(obs);
            enemies.push(obs);
        }

        // ==================== SHOOTER GAME ====================
        function setupShooterGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è to move ‚Ä¢ SPACE to shoot ‚Ä¢ Destroy 20 enemies!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrows + Space';
            document.getElementById('health-container').classList.remove('hidden');

            gameScene.background = new THREE.Color(0x111122);
            gameScene.add(new THREE.AmbientLight(0x404040));
            const light = new THREE.PointLight(0xff0000, 2, 50);
            light.position.set(0, 10, 0);
            gameScene.add(light);

            // Player
            const playerGeo = new THREE.ConeGeometry(0.5, 1, 8);
            const playerMat = getMaterial(0x00ff00);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.rotation.x = -Math.PI / 2;
            playerMesh.position.z = 5;
            gameScene.add(playerMesh);

            // Spawn enemies
            for (let i = 0; i < 5; i++) {
                spawnEnemy();
            }

            gameCamera.position.set(0, 15, 10);
            gameCamera.lookAt(0, 0, 0);
        }

        function spawnEnemy() {
            const geo = currentPlatform === '1pro' ? new THREE.BoxGeometry(1, 1, 1) : new THREE.OctahedronGeometry(0.6);
            const mat = getMaterial(0xff0000);
            const enemy = new THREE.Mesh(geo, mat);
            enemy.position.set((Math.random() - 0.5) * 10, 0.5, -10 - Math.random() * 10);
            enemy.userData = { health: 1, speed: 0.02 + Math.random() * 0.03 };
            gameScene.add(enemy);
            enemies.push(enemy);
        }

        function shootProjectile() {
            const geo = new THREE.SphereGeometry(0.2);
            const mat = getMaterial(0x00ffff);
            const proj = new THREE.Mesh(geo, mat);
            proj.position.copy(playerMesh.position);
            proj.position.y = 0.5;
            proj.userData = { speed: 0.5 };
            gameScene.add(proj);
            projectiles.push(proj);
        }

        // ==================== FIGHTING GAME ====================
        function setupFightingGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è to move ‚Ä¢ SPACE to attack ‚Ä¢ Defeat the enemy!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrows + Space';
            document.getElementById('health-container').classList.remove('hidden');

            gameScene.background = new THREE.Color(0x221111);
            gameScene.add(new THREE.AmbientLight(0x404040));
            gameScene.add(new THREE.PointLight(0xff6600, 2, 50));

            // Player
            const playerGeo = new THREE.BoxGeometry(1, 2, 0.5);
            const playerMat = getMaterial(0x00ff00);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.set(-3, 1, 0);
            gameScene.add(playerMesh);

            // Enemy
            const enemyGeo = new THREE.BoxGeometry(1, 2, 0.5);
            const enemyMat = getMaterial(0xff0000);
            const enemy = new THREE.Mesh(enemyGeo, enemyMat);
            enemy.position.set(3, 1, 0);
            enemy.userData = { health: 100 };
            gameScene.add(enemy);
            enemies.push(enemy);

            // Arena floor
            const floorGeo = new THREE.PlaneGeometry(15, 10);
            const floorMat = getMaterial(0x444444);
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            gameScene.add(floor);

            gameCamera.position.set(0, 5, 10);
            gameCamera.lookAt(0, 1, 0);
        }

        // ==================== SPORTS GAME ====================
        function setupSportsGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è ‚¨ÜÔ∏è ‚¨áÔ∏è to move ‚Ä¢ SPACE to kick ‚Ä¢ Score 5 goals!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrows + Space';
            document.getElementById('timer-container').classList.remove('hidden');

            gameScene.background = new THREE.Color(0x115511);
            gameScene.add(new THREE.AmbientLight(0x606060));
            gameScene.add(new THREE.DirectionalLight(0xffffff, 0.8));

            // Player
            const playerGeo = new THREE.CylinderGeometry(0.3, 0.3, 1.5);
            const playerMat = getMaterial(0x0000ff);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.set(0, 0.75, 3);
            gameScene.add(playerMesh);

            // Ball
            const ballGeo = new THREE.SphereGeometry(0.3, 16, 16);
            const ballMat = getMaterial(0xffffff);
            const ball = new THREE.Mesh(ballGeo, ballMat);
            ball.position.set(0, 0.3, 0);
            ball.userData = { type: 'ball', vx: 0, vz: 0 };
            gameScene.add(ball);
            collectibles.push(ball);

            // Goal
            const goalGeo = new THREE.BoxGeometry(4, 2, 0.2);
            const goalMat = getMaterial(0xffffff);
            const goal = new THREE.Mesh(goalGeo, goalMat);
            goal.position.set(0, 1, -8);
            goal.userData = { type: 'goal' };
            gameScene.add(goal);

            // Field
            const fieldGeo = new THREE.PlaneGeometry(12, 20);
            const fieldMat = getMaterial(0x228822);
            const field = new THREE.Mesh(fieldGeo, fieldMat);
            field.rotation.x = -Math.PI / 2;
            gameScene.add(field);

            gameCamera.position.set(0, 12, 12);
            gameCamera.lookAt(0, 0, -2);
        }

        // ==================== ADVENTURE GAME ====================
        function setupAdventureGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è ‚¨ÜÔ∏è ‚¨áÔ∏è to move ‚Ä¢ Collect 15 gems!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrow Keys';
            document.getElementById('health-container').classList.remove('hidden');

            gameScene.background = new THREE.Color(0x112211);
            gameScene.add(new THREE.AmbientLight(0x404040));
            gameScene.add(new THREE.PointLight(0x00ff00, 1, 30));

            // Player
            const playerGeo = new THREE.SphereGeometry(0.5, 16, 16);
            const playerMat = getMaterial(0x00ffff);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.y = 0.5;
            gameScene.add(playerMesh);

            // Spawn gems
            for (let i = 0; i < 15; i++) {
                const gemGeo = new THREE.OctahedronGeometry(0.3);
                const gemMat = getMaterial(0xffff00);
                const gem = new THREE.Mesh(gemGeo, gemMat);
                gem.position.set((Math.random() - 0.5) * 15, 0.5, (Math.random() - 0.5) * 15);
                gem.userData = { type: 'gem' };
                gameScene.add(gem);
                collectibles.push(gem);
            }

            // Spawn traps
            for (let i = 0; i < 5; i++) {
                const trapGeo = new THREE.BoxGeometry(1, 0.3, 1);
                const trapMat = getMaterial(0xff0000);
                const trap = new THREE.Mesh(trapGeo, trapMat);
                trap.position.set((Math.random() - 0.5) * 12, 0.15, (Math.random() - 0.5) * 12);
                trap.userData = { type: 'trap' };
                gameScene.add(trap);
                enemies.push(trap);
            }

            // Ground
            const groundGeo = new THREE.PlaneGeometry(20, 20);
            const groundMat = getMaterial(0x336633);
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            gameScene.add(ground);

            gameCamera.position.set(0, 15, 10);
            gameCamera.lookAt(0, 0, 0);
        }

        // ==================== PLATFORMER GAME ====================
        function setupPlatformerGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è to move ‚Ä¢ SPACE to jump ‚Ä¢ Reach the flag!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrows + Space';

            gameScene.background = new THREE.Color(0x87CEEB);
            gameScene.add(new THREE.AmbientLight(0x808080));
            gameScene.add(new THREE.DirectionalLight(0xffffff, 0.5));

            // Player
            const playerGeo = new THREE.BoxGeometry(0.8, 1, 0.8);
            const playerMat = getMaterial(0xff0000);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.set(-8, 1, 0);
            playerMesh.userData = { vy: 0, grounded: true };
            gameScene.add(playerMesh);

            // Platforms
            const platforms = [
                { x: -8, y: 0, w: 4 },
                { x: -3, y: 1.5, w: 3 },
                { x: 2, y: 3, w: 3 },
                { x: 7, y: 4.5, w: 4 }
            ];
            platforms.forEach(p => {
                const geo = new THREE.BoxGeometry(p.w, 0.5, 2);
                const mat = getMaterial(0x8B4513);
                const plat = new THREE.Mesh(geo, mat);
                plat.position.set(p.x, p.y, 0);
                plat.userData = { type: 'platform' };
                gameScene.add(plat);
                collectibles.push(plat);
            });

            // Flag
            const flagGeo = new THREE.ConeGeometry(0.3, 1, 8);
            const flagMat = getMaterial(0x00ff00);
            const flag = new THREE.Mesh(flagGeo, flagMat);
            flag.position.set(7, 6, 0);
            flag.userData = { type: 'flag' };
            gameScene.add(flag);
            collectibles.push(flag);

            gameCamera.position.set(0, 5, 15);
            gameCamera.lookAt(0, 2, 0);
        }

        // ==================== STRATEGY GAME ====================
        function setupStrategyGame() {
            document.getElementById('instructions-text').textContent = 'Click units to collect resources ‚Ä¢ Reach 500 points!';
            document.getElementById('game-controls-hint').textContent = 'üñ±Ô∏è Click to collect';
            document.getElementById('timer-container').classList.remove('hidden');

            gameScene.background = new THREE.Color(0x222233);
            gameScene.add(new THREE.AmbientLight(0x606060));
            gameScene.add(new THREE.DirectionalLight(0xffffff, 0.5));

            // Base
            const baseGeo = new THREE.BoxGeometry(2, 1, 2);
            const baseMat = getMaterial(0x0000ff);
            playerMesh = new THREE.Mesh(baseGeo, baseMat);
            playerMesh.position.set(0, 0.5, 0);
            gameScene.add(playerMesh);

            // Resources
            for (let i = 0; i < 20; i++) {
                spawnResource();
            }

            // Ground
            const groundGeo = new THREE.PlaneGeometry(30, 30);
            const groundMat = getMaterial(0x445544);
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            gameScene.add(ground);

            gameCamera.position.set(0, 20, 15);
            gameCamera.lookAt(0, 0, 0);

            // Click handler for strategy
            gameRenderer.domElement.onclick = (e) => {
                if (!gameActive) return;
                const rect = gameRenderer.domElement.getBoundingClientRect();
                const mouse = new THREE.Vector2(
                    ((e.clientX - rect.left) / rect.width) * 2 - 1,
                    -((e.clientY - rect.top) / rect.height) * 2 + 1
                );
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, gameCamera);
                const intersects = raycaster.intersectObjects(collectibles);
                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    if (obj.userData.type === 'resource') {
                        gameScore += 25;
                        gameScene.remove(obj);
                        collectibles = collectibles.filter(c => c !== obj);
                        spawnResource();
                        updateGameUI();
                        if (gameScore >= 500) completeGame(true);
                    }
                }
            };
        }

        function spawnResource() {
            const geo = new THREE.DodecahedronGeometry(0.4);
            const colors = [0xffff00, 0x00ff00, 0xff00ff];
            const mat = getMaterial(colors[Math.floor(Math.random() * colors.length)]);
            const res = new THREE.Mesh(geo, mat);
            res.position.set((Math.random() - 0.5) * 25, 0.5, (Math.random() - 0.5) * 25);
            res.userData = { type: 'resource' };
            gameScene.add(res);
            collectibles.push(res);
        }

        // ==================== DEFAULT GAME ====================
        function setupDefaultGame() {
            document.getElementById('instructions-text').textContent = '‚¨ÖÔ∏è ‚û°Ô∏è to move ‚Ä¢ Collect items ‚Ä¢ Score 300 points!';
            document.getElementById('game-controls-hint').textContent = 'üéÆ Arrow Keys';

            gameScene.background = new THREE.Color(0x222222);
            gameScene.add(new THREE.AmbientLight(0x606060));

            const playerGeo = new THREE.SphereGeometry(0.5);
            const playerMat = getMaterial(0x00ff00);
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            gameScene.add(playerMesh);

            for (let i = 0; i < 10; i++) {
                const geo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const mat = getMaterial(0xffff00);
                const item = new THREE.Mesh(geo, mat);
                item.position.set((Math.random() - 0.5) * 15, 0.25, (Math.random() - 0.5) * 15);
                item.userData = { type: 'item' };
                gameScene.add(item);
                collectibles.push(item);
            }

            const groundGeo = new THREE.PlaneGeometry(20, 20);
            const groundMat = getMaterial(0x444444);
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            gameScene.add(ground);

            gameCamera.position.set(0, 15, 10);
            gameCamera.lookAt(0, 0, 0);
        }

        // ==================== HELPERS ====================
        function getMaterial(color) {
            if (currentPlatform === '1pro') {
                return new THREE.MeshBasicMaterial({ color });
            } else if (currentPlatform === '2pro') {
                return new THREE.MeshPhongMaterial({ color, shininess: 50 });
            } else {
                return new THREE.MeshStandardMaterial({ color, metalness: 0.3, roughness: 0.7 });
            }
        }

        // ==================== GAME LOOP ====================
        function gameLoop() {
            if (!gameActive) return;
            gameAnimationId = requestAnimationFrame(gameLoop);

            const genre = currentGame.genre;

            if (genre === 'Racing') updateRacing();
            else if (genre === 'FPS' || genre === 'Action') updateShooter();
            else if (genre === 'Fighting') updateFighting();
            else if (genre === 'Sports') updateSports();
            else if (genre === 'Adventure' || genre === 'Survival') updateAdventure();
            else if (genre === 'Platformer') updatePlatformer();
            else if (genre === 'Strategy' || genre === 'Economic' || genre === 'Building') updateStrategy();
            else updateDefault();

            gameRenderer.render(gameScene, gameCamera);
        }

        function updateRacing() {
            // Move player
            if (keys['ArrowLeft'] || keys['KeyA']) playerPos.x = Math.max(playerPos.x - 0.15, -3);
            if (keys['ArrowRight'] || keys['KeyD']) playerPos.x = Math.min(playerPos.x + 0.15, 3);
            playerMesh.position.x = playerPos.x;

            // Move obstacles
            enemies.forEach(obs => {
                obs.position.z += 0.3 + gameLevel * 0.05;
                obs.rotation.y += 0.02;
                
                if (obs.position.z > 10) {
                    gameScore += 10;
                    updateGameUI();
                    obs.position.z = -100;
                    obs.position.x = (Math.random() - 0.5) * 6;
                    if (gameScore % 100 === 0) gameLevel++;
                }

                // Collision
                if (Math.abs(obs.position.x - playerMesh.position.x) < 1.2 &&
                    Math.abs(obs.position.z - playerMesh.position.z) < 1.5) {
                    perfectRun = false;
                    obs.position.z = -100;
                    playerHealth -= 20;
                    document.getElementById('game-container').classList.add('shake');
                    setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 300);
                    if (playerHealth <= 0) completeGame(false);
                }
            });

            if (gameScore >= 1000) completeGame(true);
        }

        function updateShooter() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x = Math.max(playerMesh.position.x - 0.1, -6);
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x = Math.min(playerMesh.position.x + 0.1, 6);

            // Projectiles
            projectiles.forEach((proj, i) => {
                proj.position.z -= proj.userData.speed;
                if (proj.position.z < -20) {
                    gameScene.remove(proj);
                    projectiles.splice(i, 1);
                }

                // Hit enemy
                enemies.forEach((enemy, j) => {
                    if (proj.position.distanceTo(enemy.position) < 1) {
                        gameScene.remove(proj);
                        gameScene.remove(enemy);
                        projectiles.splice(i, 1);
                        enemies.splice(j, 1);
                        gameScore += 50;
                        updateGameUI();
                        spawnEnemy();
                        if (gameScore >= 1000) completeGame(true);
                    }
                });
            });

            // Enemies move toward player
            enemies.forEach(enemy => {
                enemy.position.z += enemy.userData.speed;
                enemy.rotation.y += 0.02;
                if (enemy.position.z > 6) {
                    perfectRun = false;
                    playerHealth -= 10;
                    updateHealthBar();
                    enemy.position.z = -15;
                    enemy.position.x = (Math.random() - 0.5) * 10;
                    if (playerHealth <= 0) completeGame(false);
                }
            });
        }

        function updateFighting() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x = Math.max(playerMesh.position.x - 0.08, -5);
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x = Math.min(playerMesh.position.x + 0.08, 5);

            enemies.forEach(enemy => {
                // Enemy AI
                if (enemy.position.x > playerMesh.position.x + 1.5) enemy.position.x -= 0.03;
                else if (enemy.position.x < playerMesh.position.x - 1.5) enemy.position.x += 0.03;
                else if (Math.random() < 0.02) {
                    perfectRun = false;
                    playerHealth -= 5;
                    updateHealthBar();
                    if (playerHealth <= 0) completeGame(false);
                }

                if (enemy.userData.health <= 0) {
                    gameScore += 100;
                    enemy.userData.health = 100;
                    gameLevel++;
                    updateGameUI();
                    if (gameLevel > 5) completeGame(true);
                }
            });
        }

        function updateSports() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x = Math.max(playerMesh.position.x - 0.1, -5);
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x = Math.min(playerMesh.position.x + 0.1, 5);
            if (keys['ArrowUp'] || keys['KeyW']) playerMesh.position.z = Math.max(playerMesh.position.z - 0.1, -7);
            if (keys['ArrowDown'] || keys['KeyS']) playerMesh.position.z = Math.min(playerMesh.position.z + 0.1, 7);

            collectibles.forEach(ball => {
                if (ball.userData.type !== 'ball') return;
                
                // Ball physics
                ball.position.x += ball.userData.vx;
                ball.position.z += ball.userData.vz;
                ball.userData.vx *= 0.98;
                ball.userData.vz *= 0.98;

                // Boundaries
                if (Math.abs(ball.position.x) > 5) ball.userData.vx *= -0.8;
                if (ball.position.z > 8) {
                    ball.position.set(0, 0.3, 0);
                    ball.userData.vx = ball.userData.vz = 0;
                }

                // Goal!
                if (ball.position.z < -7.5 && Math.abs(ball.position.x) < 2) {
                    gameScore += 100;
                    gameLevel++;
                    updateGameUI();
                    ball.position.set(0, 0.3, 0);
                    ball.userData.vx = ball.userData.vz = 0;
                    if (gameLevel > 5) completeGame(true);
                }

                // Player kicks ball
                if (playerMesh.position.distanceTo(ball.position) < 1) {
                    ball.userData.vz = -0.3;
                    ball.userData.vx = (ball.position.x - playerMesh.position.x) * 0.1;
                }
            });

            gameTimer -= 0.016;
            document.getElementById('game-timer').textContent = Math.ceil(gameTimer);
            if (gameTimer <= 0) completeGame(gameScore > 0);
        }

        function updateAdventure() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x -= 0.1;
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x += 0.1;
            if (keys['ArrowUp'] || keys['KeyW']) playerMesh.position.z -= 0.1;
            if (keys['ArrowDown'] || keys['KeyS']) playerMesh.position.z += 0.1;

            playerMesh.position.x = Math.max(-9, Math.min(9, playerMesh.position.x));
            playerMesh.position.z = Math.max(-9, Math.min(9, playerMesh.position.z));

            collectibles.forEach((gem, i) => {
                if (gem.userData.type !== 'gem') return;
                gem.rotation.y += 0.05;
                if (playerMesh.position.distanceTo(gem.position) < 1) {
                    gameScore += 50;
                    updateGameUI();
                    gameScene.remove(gem);
                    collectibles.splice(i, 1);
                    if (collectibles.filter(c => c.userData.type === 'gem').length === 0) {
                        completeGame(true);
                    }
                }
            });

            enemies.forEach(trap => {
                if (playerMesh.position.distanceTo(trap.position) < 0.8) {
                    perfectRun = false;
                    playerHealth -= 1;
                    updateHealthBar();
                    if (playerHealth <= 0) completeGame(false);
                }
            });
        }

        function updatePlatformer() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x -= 0.1;
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x += 0.1;

            // Gravity
            playerMesh.userData.vy -= 0.01;
            playerMesh.position.y += playerMesh.userData.vy;

            // Check platform collisions
            playerMesh.userData.grounded = false;
            collectibles.forEach(plat => {
                if (plat.userData.type !== 'platform') return;
                if (playerMesh.position.y < plat.position.y + 0.8 &&
                    playerMesh.position.y > plat.position.y &&
                    Math.abs(playerMesh.position.x - plat.position.x) < 2 &&
                    playerMesh.userData.vy < 0) {
                    playerMesh.position.y = plat.position.y + 0.75;
                    playerMesh.userData.vy = 0;
                    playerMesh.userData.grounded = true;
                }
            });

            // Fall death
            if (playerMesh.position.y < -5) {
                perfectRun = false;
                playerMesh.position.set(-8, 1, 0);
                playerMesh.userData.vy = 0;
                gameScore = Math.max(0, gameScore - 20);
                updateGameUI();
            }

            // Check flag
            collectibles.forEach(item => {
                if (item.userData.type === 'flag' && playerMesh.position.distanceTo(item.position) < 1) {
                    gameScore += 200;
                    completeGame(true);
                }
            });
        }

        function updateStrategy() {
            collectibles.forEach(res => {
                if (res.userData.type === 'resource') {
                    res.rotation.y += 0.02;
                }
            });

            gameTimer -= 0.016;
            document.getElementById('game-timer').textContent = Math.ceil(gameTimer);
            if (gameTimer <= 0) completeGame(gameScore >= 300);
        }

        function updateDefault() {
            if (keys['ArrowLeft'] || keys['KeyA']) playerMesh.position.x -= 0.1;
            if (keys['ArrowRight'] || keys['KeyD']) playerMesh.position.x += 0.1;
            if (keys['ArrowUp'] || keys['KeyW']) playerMesh.position.z -= 0.1;
            if (keys['ArrowDown'] || keys['KeyS']) playerMesh.position.z += 0.1;

            collectibles.forEach((item, i) => {
                item.rotation.y += 0.03;
                if (playerMesh.position.distanceTo(item.position) < 1) {
                    gameScore += 30;
                    updateGameUI();
                    gameScene.remove(item);
                    collectibles.splice(i, 1);
                    
                    // Respawn
                    const geo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                    const mat = getMaterial(0xffff00);
                    const newItem = new THREE.Mesh(geo, mat);
                    newItem.position.set((Math.random() - 0.5) * 15, 0.25, (Math.random() - 0.5) * 15);
                    newItem.userData = { type: 'item' };
                    gameScene.add(newItem);
                    collectibles.push(newItem);

                    if (gameScore >= 300) completeGame(true);
                }
            });
        }

        function updateGameUI() {
            document.getElementById('game-score').textContent = gameScore;
            document.getElementById('game-level').textContent = gameLevel;
        }

        function updateHealthBar() {
            document.getElementById('health-bar').style.width = playerHealth + '%';
        }

        // ==================== INPUT ====================
        function setupGameInput() {
            document.onkeydown = (e) => {
                keys[e.code] = true;
                
                if (e.code === 'Space') {
                    e.preventDefault();
                    const genre = currentGame.genre;
                    if (genre === 'FPS' || genre === 'Action') shootProjectile();
                    else if (genre === 'Fighting') attackEnemy();
                    else if (genre === 'Platformer' && playerMesh.userData.grounded) {
                        playerMesh.userData.vy = 0.25;
                        playerMesh.userData.grounded = false;
                    }
                }
                if (e.code === 'Escape') exitGame();
            };
            document.onkeyup = (e) => keys[e.code] = false;
        }

        function attackEnemy() {
            enemies.forEach(enemy => {
                if (Math.abs(enemy.position.x - playerMesh.position.x) < 2) {
                    enemy.userData.health -= 20;
                    gameScore += 20;
                    updateGameUI();
                }
            });
        }

        // ==================== COMPLETE ====================
        function completeGame(won) {
            gameActive = false;
            cancelAnimationFrame(gameAnimationId);

            const basePoints = currentGame.points;
            const bonus = (won && perfectRun) ? 20 : 0;
            const total = won ? basePoints + bonus : Math.floor(basePoints * 0.3);

            gameData.user.points += total;
            gameData.user.totalEarned += total;
            if (won) gameData.user.gamesCompleted++;
            saveData();

            document.getElementById('complete-icon').textContent = won ? 'üèÜ' : 'üíÄ';
            document.getElementById('complete-title').textContent = won ? 'VICTORY!' : 'GAME OVER';
            document.getElementById('earned-points').textContent = total;
            document.getElementById('bonus-text').textContent = bonus > 0 ? `+${bonus} Perfect Run Bonus!` : '';
            document.getElementById('complete-message').textContent = won ? 
                (perfectRun ? 'Flawless victory!' : 'Great job!') : 'Better luck next time!';
            document.getElementById('new-balance').textContent = gameData.user.points;
            document.getElementById('complete-modal').classList.remove('hidden');
        }

        function closeCompleteModal() {
            document.getElementById('complete-modal').classList.add('hidden');
            exitGame();
        }

        function exitGame() {
            gameActive = false;
            document.getElementById('game-screen').classList.add('hidden');
            if (gameAnimationId) cancelAnimationFrame(gameAnimationId);
            if (gameRenderer) {
                gameRenderer.domElement.onclick = null;
            }
            enemies = [];
            collectibles = [];
            projectiles = [];
            keys = {};
            document.onkeydown = null;
            document.onkeyup = null;
        }

        // ==================== SHOP ====================
        function showShop() {
            document.getElementById('shop-modal').classList.remove('hidden');
            updateUI();
        }

        function closeShop() {
            document.getElementById('shop-modal').classList.add('hidden');
        }

        function buySubscription(tier) {
            const prices = { 'pro': 900, 'pro+': 1200 };
            const price = prices[tier];

            if (gameData.user.points < price) {
                alert(`You need ${price - gameData.user.points} more points!`);
                return;
            }

            if (gameData.user.subscriptions.includes(tier)) {
                alert('Already owned!');
                return;
            }

            gameData.user.points -= price;
            gameData.user.subscriptions.push(tier);
            saveData();

            const card = tier === 'pro' ? document.getElementById('pro-card') : document.getElementById('proplus-card');
            card.style.transform = 'scale(1.1)';
            card.style.boxShadow = '0 0 50px ' + (tier === 'pro' ? '#4caf50' : '#2196f3');
            
            setTimeout(() => {
                card.style.transform = '';
                card.style.boxShadow = '';
                closeShop();
                if (currentPlatform) {
                    renderGames();
                    document.getElementById('subscription-banner').classList.add('hidden');
                }
                alert(`üéâ ${tier === 'pro' ? 'Game Max Pro' : 'Game Max Pro+'} unlocked! Enjoy your new games!`);
            }, 500);
        }

        // ==================== UPLOAD ====================
        function showUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
            document.getElementById('upload-form').classList.add('hidden');
        }

        function setupEvents() {
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('file-input');
            const searchInput = document.getElementById('search-input');

            uploadZone.ondragover = (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); };
            uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
            uploadZone.ondrop = (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleUpload(e.dataTransfer.files[0]);
            };
            fileInput.onchange = (e) => handleUpload(e.target.files[0]);
            searchInput.oninput = () => renderGames();
        }

        function handleUpload(file) {
            if (!file) return;
            document.getElementById('upload-form').classList.remove('hidden');
            document.getElementById('game-name-input').value = file.name.replace(/\.[^/.]+$/, '');
        }

        function publishGame() {
            const title = document.getElementById('game-name-input').value;
            const genre = document.getElementById('game-genre-input').value;
            if (!title || !genre) { alert('Fill all fields!'); return; }

            gameData.uploadedGames.push({
                id: 'user_' + Date.now(),
                platform: currentPlatform,
                title, genre,
                points: 50,
                exclusive: false,
                uploaded: true
            });
            saveData();
            closeUploadModal();
            renderGames();
            alert('Game published!');
        }

        window.onload = init;
    </script>
</body>
</html>
